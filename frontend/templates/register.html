{% extends 'base.html' %}

{% block content %}

<div class="container">
    <div class="auth-card">
        <h1 class="auth-card__title">Register</h1>

        <!-- This form is handled by JavaScript -->
        <form id="registerForm" class="auth-card__form">
            <div class="form-group">
                <label for="username" class="form__label">Username *</label>
                <input type="text" id="username" class="form__input" minlength="5" required>
            </div>
            <div class="form-group">
                <label for="email" class="form__label">Email *</label>
                <input type="email" id="email" class="form__input" required placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="firstName" class="form__label">First Name</label>
                <input type="text" id="firstName" class="form__input" placeholder="Enter your first name (optional)">
            </div>
            <div class="form-group">
                <label for="lastName" class="form__label">Last Name</label>
                <input type="text" id="lastName" class="form__input" placeholder="Enter your last name (optional)">
            </div>
            <div class="form-group">
                <label for="phoneNumber" class="form__label">Phone Number</label>
                <input type="text" id="phoneNumber" class="form__input" placeholder="Enter your phone number (optional)">
            </div>
            <div class="form-group">
                <label for="password" class="form__label">Password *</label>
                <input type="password" id="password" class="form__input" required placeholder="Minimum 8 characters">
            </div>
            <div class="form-group">
                <label for="password" class="form__label">Confirm Password *</label>
                <input type="password" id="confirmPassword" class="form__input" required placeholder="Minimum 8 characters">
            </div>
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            <button type="submit" class="form__submit-btn" id="registerBtn">Register</button>
        </form>
        <div class="existing-account">
            <p>Already have an account? <a href="/auth/login">Login</a></p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
    // Check if already logged in
    redirectIfAuthenticated();

    // Password validation (real-time)
    const form = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const errorMessage = document.getElementById('errorMessage');

    document.getElementById('password').addEventListener('input', (event) => {
        const password = event.target.value;
        const feedback = [];

        if (password.length < 8) feedback.push('Password must be at least 8 characters long');
        if (!/[A-Z]/.test(password)) feedback.push('Password must contain at least one uppercase letter');
        if (!/[a-z]/.test(password)) feedback.push('Password must contain at least one lowercase letter');
        if (!/\d/.test(password)) feedback.push('Password must contain at least one digit');

        if (feedback.length > 0) {
            errorMessage.textContent = feedback.join(', ');
            errorMessage.style.display = 'block';
        } else {
            errorMessage.style.display = 'none';
        }
    });

    // JavaScript to handle form submission and error handling
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Collect form data
        const formData = {
            username: document.getElementById('username').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
            first_name: document.getElementById('firstName').value.trim() || undefined,
            last_name: document.getElementById('lastName').value.trim() || undefined,
            phone_number: document.getElementById('phoneNumber').value.trim() || undefined
        };

        // Validate passwords match
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (formData.password !== confirmPassword) {
            errorMessage.textContent = 'Passwords do not match';
            errorMessage.style.display = 'block';
            return;
        }

        // Clean up undefined values
        Object.keys(formData).forEach(key => {
            if (formData[key] === undefined) delete formData[key];
        });

        // Show loading state
        registerBtn.disabled = true;
        registerBtn.textContent = 'Creating account...';
        errorMessage.style.display = 'none';

        // Call POST /auth/register endpoint
        try {
            const result = await API.register(formData);

            if (result.success) {
                alert('Account created successfully! Please login.');
                window.location.href = '/auth/login';
            } else {
                errorMessage.textContent = result.error;
                errorMessage.style.display = 'block';
            }
        } catch (error) {
            errorMessage.textContent = 'Network error. Please try again.';
            errorMessage.style.display = 'block';
        } finally {
            // Reset button state
            registerBtn.disabled = false;
            registerBtn.textContent = 'Register';
        }
    });
</script>

{% endblock %}